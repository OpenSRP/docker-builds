FROM java:openjdk-8u111-jre

MAINTAINER Samuel Githengi (sgithengi@ona.io)

RUN apt-get update
RUN apt-get install -y netcat

RUN wget --quiet --no-cookies https://github.com/mybatis/migrations/releases/download/mybatis-migrations-3.3.4/mybatis-migrations-3.3.4-bundle.zip -O /opt/mybatis-migrations-3.3.4.zip

# Unpack the distribution
RUN unzip /opt/mybatis-migrations-3.3.4.zip -d /opt/
RUN rm -f /opt/mybatis-migrations-3.3.4.zip
RUN chmod +x /opt/mybatis-migrations-3.3.4/bin/migrate

WORKDIR /migrate

# Add command scripts
ADD sh/migrate.sh /opt/migrate.sh

#Build arguments
ARG opensrp_server_tag

#Download opensrp_server
RUN wget --quiet --no-cookies https://github.com/OpenSRP/opensrp-server/archive/${opensrp_server_tag}.tar.gz -O /tmp/${opensrp_server_tag}.tar.gz 

RUN tar -xf /tmp/${opensrp_server_tag}.tar.gz -C /tmp && cp -R /tmp/opensrp-server-${opensrp_server_tag}/assets/migrations/* /migrate

RUN mkdir -p /etc/migrations

VOLUME /etc/migrations

#Install database clients
RUN apt-get update && \
apt-get install -y mysql-client && \
apt-get install -y postgresql-client && \
rm -rf /var/lib/apt/lists/*

COPY sql /opt/sql

COPY sh/*.sh /usr/local/bin/

ENTRYPOINT ["/opt/migrate.sh"]